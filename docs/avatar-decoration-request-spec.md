# アバターデコレーション申請機能 - 仕様書
_作成日: 2025/10/28_

## 概要
「アバターデコレーション」を、シュリンピアポータルから申請できる機能および、管理者向けの機能の仕様を定義します。
アバターデコレーションとはMisskeyにおける機能の一つで、ユーザーのアイコン周辺を一枚絵で装飾できます。

## 機能要件
### 1. ユーザー向け申請機能
- ユーザーはシュリンピアポータルの専用ページからアバターデコレーションの申請ができる。
- 申請フォームには以下の項目を含む:
  - デコレーション画像のアップロード（PNG形式、最大5MB、512x512）
    - 画像はCloudflare R2等、既存絵文字申請と同様のストレージに保存
    - 画像サイズ・形式・解像度のバリデーションを厳格に実施
  - デコレーション名
  - デコレーションの説明
  - ガイドラインに同意するチェックボックス
  - テンプレート（src/assets/avatar-decoration-template.png）をオーバーレイ表示し、赤色のラインをはみ出していないことを確認するチェックボックス
    - 判定はユーザー自己申告
- ユーザーごとに、月々申請可能な個数が決まっている。ユーザーの有料会員であるShrimpia+の会員プランに応じて、申請可能な個数が変動する。アカウントの会員プランを取得する方法については、既存処理を参照すること。
  - 申請上限は月初リセット（絵文字申請と同様）
  - 非会員: 0
  - Shrimpia+ Lite: 1
  - Shrimpia+: 2
  - Shrimpia+ Pro: 3
### 2. 管理者向け承認機能
- 管理者は申請されたアバターデコレーションを一覧で確認できる。
- 各申請に対して「承認」または「拒否」のアクションを実行できる。
- 承認されたデコレーションは自動的にMisskeyサーバーに登録される。
  - Misskey APIを用いて登録処理を行う（API呼び出し詳細は後述）
- 拒否時には「コメント」を入力する必要がある（最大500文字）。
- 承認・拒否時には、ユーザーのMisskeyアカウントに通知が送信される。
  - カスタム絵文字の申請と同様の機能を用いること
### 3. 通知機能
- 申請が承認または拒否された際に、ユーザーに通知が送信される。
- 通知には以下の情報を含む:
  - 承認の場合: デコレーション名、承認された旨のメッセージ
  - 拒否の場合: デコレーション名、拒否された旨のメッセージ、管理者からのコメント
- 申請が作成された際に、Discord Webhookを用いて管理者向けチャンネルに通知が送信される。
  - 既存の絵文字申請と同様の実装を踏襲すること
  - 通知内容には以下の情報を含む:
    - デコレーション名
    - 説明
    - 申請者の情報（名前、アイコン、ユーザー名）
    - デコレーション画像のサムネイル
    - 管理ページへのリンク
### 4. 申請されたデコレーション一覧表示機能
- ユーザーは、これまで申請されたアバターデコレーションの一覧を確認できる。
- 各申請のステータス（承認待ち、承認済み、拒否済み）を表示する。
- 自分が申請したデコレーションのみを表示するフィルター機能を提供する。
- 一覧は無限スクロールで表示する。
- 一覧はカード形式で表示し、各カードには以下の情報を含む:
  - デコレーション画像のサムネイル
  - デコレーション名および説明
  - 申請日時
  - ステータス（承認待ち、承認済み、拒否済み）
  - 拒否された場合は管理者からのコメント


## 非機能要件
- 申請フォームおよび管理者画面はレスポンシブデザインで実装すること。
- 画像アップロードの仕組み等については、既存のカスタム絵文字申請機能と同様の実装を踏襲すること。
- 管理者画面向けのAPIエンドポイントは、既存の管理者APIと同様の認証・認可方式を採用すること。
- 管理者画面へのアクセスについては、既存の管理者画面と同様のセキュリティ対策を適用すること。
- 申請データおよび承認・拒否履歴は、適切にデータベースに保存されること。

## テーブル定義
SQLiteを想定したテーブル定義を以下に示します。
### avatar_decorations_requests
| カラム名          | データ型     | 制約                     | 説明                           |
|------------------|--------------|--------------------------|--------------------------------|
| id               | TEXT         | PRIMARY KEY              | 申請ID                         |
| user_id          | TEXT         | NOT NULL                 | 申請者のユーザーID             |
| decoration_name  | TEXT         | NOT NULL                 | デコレーション名                 |
| description      | TEXT         |                          | デコレーションの説明           |
| image_path       | TEXT         | NOT NULL                 | アップロードされた画像のパス     |
| status           | TEXT         | NOT NULL                 | 申請ステータス（pending, approved, rejected）|
| admin_comment    | TEXT         |                          | 管理者からのコメント（拒否時のみ）|
| created_at       | DATETIME     | | NOT NULL                 | 申請日時                       |
| updated_at       | DATETIME     | | NOT NULL                 | 更新日時                       |

## APIエンドポイント
### ユーザー向けAPI
- `POST /api/avatar-decorations/requests`
  - 説明: アバターデコレーションの申請を作成する
  - リクエストボディ:
    - decoration_name: string
    - description: string
    - image: file (PNG形式)
  - レスポンス:
    - 201 Created: 申請が正常に作成された場合
    - 400 Bad Request: 入力データが不正な場合または、申請可能な上限に達している場合
  - 認証: アカウント認証が必要
- `GET /api/avatar-decorations/requests/me`
  - 説明: 自分が申請したアバターデコレーションの一覧を取得する
  - クエリパラメータ:
    - page: integer (ページ番号、デフォルト1)
    - per_page: integer (1ページあたりの件数、デフォルト20)
  - レスポンス:
    - 200 OK: 申請一覧を返す
  - 認証: アカウント認証が必要
- `GET /api/avatar-decorations/requests`
  - 説明: すべての申請されたアバターデコレーションの一覧を取得する
  - クエリパラメータ:
    - page: integer (ページ番号、デフォルト1)
    - per_page: integer (1ページあたりの件数、デフォルト20)
  - レスポンス:
    - 200 OK: 申請一覧を返す
  - 認証: アカウント認証が必要
### 管理者向けAPI
- `GET /api/admin/avatar-decorations/requests`
  - 説明: 申請されたアバターデコレーションの一覧を取得する
  - レスポンス:
    - 200 OK: 申請一覧を返す
  - 認証: 管理者認証が必要
- `POST /api/admin/avatar-decorations/requests/{id}/approve`
  - 説明: 指定された申請を承認する
  - パスパラメータ:
    - id: UUID (申請ID)
  - レスポンス:
    - 200 OK: 申請が正常に承認された場合
    - 404 Not Found: 指定された申請が存在しない場合
  - 認証: 管理者認証が必要
  - 備考: Misskey APIを用いてデコレーションを登録する処理を含む。以下に、必要なAPIを示す。
- `POST /api/admin/avatar-decorations/requests/{id}/reject`
  - 説明: 指定された申請を拒否する
  - パスパラメータ:
    - id: UUID (申請ID)
  - リクエストボディ:
    - admin_comment: string（最大500文字）
  - レスポンス:
    - 200 OK: 申請が正常に拒否された場合
    - 404 Not Found: 指定された申請が存在しない場合
  - 認証: 管理者認証が必要

## 必要なMisskey API
- `POST api/admin/avatar-decorations/create`
  - 説明: 新しいアバターデコレーションをMisskeyに登録する
  - リクエストボディ（JSON）:
    - name: string (デコレーション名)
    - description: string?（アバターの説明）
    - url: string (デコレーション画像のURL)
    - roleIdsThatCanBeUsedThisDecoration: string[] (このデコレーションを使用できるロールIDの配列、空配列で全ロールに許可)
      今回は `[]` でOK
  - 認証: 管理者認証が必要
  - レスポンス:
    - 200 OK: デコレーションが正常に登録された場合
    - 400 Bad Request: 入力データが不正な場合
    - 401 Unauthorized: 認証に失敗した場合

## システム全体構成図

```mermaid
flowchart TD
    subgraph ユーザー
        U1[申請フォーム入力]
        U2[申請履歴一覧・ステータス確認]
    end
    subgraph 管理者
        A1[申請一覧確認]
        A2[承認・拒否アクション]
    end
    U1 -->|申請| B1[API: /api/avatar-decorations/requests]
    B1 -->|DB保存| DB[(DB: avatar_decorations_requests)]
    U2 -->|一覧取得| B2[API: /api/avatar-decorations/requests/me]
    A1 -->|一覧取得| B3[API: /api/admin/avatar-decorations/requests]
    A2 -->|承認/拒否| B4[API: /api/admin/avatar-decorations/requests/{id}/approve/reject]
    B4 -->|MisskeyAPI連携| M1[Misskeyサーバー]
    B4 -->|通知| N1[ユーザー通知]
    B1 -->|画像アップロード| S1[Cloudflare R2等ストレージ]
```
